input {
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => ["ci_raw_lines"]
    group_id => "logstash-ci-raw"
    auto_offset_reset => "earliest"
    codec => json
  }
}

filter {

  # ---------------- FILE ID ----------------
  mutate {
    copy => { "file_id" => "[@metadata][file_id]" }
  }

  # ---------------- FILE START ----------------
  if [event_type] == "file_start" {
    aggregate {
      task_id => "%{[@metadata][file_id]}"
      code => "
        map['day_folder'] = event.get('day_folder')
        map['filename'] = event.get('filename')
        map['path'] = event.get('path')
        map['builder'] = nil
        map['result_status'] = nil
      "
    }
    drop {}
  }

  # ---------------- RAW LINE ----------------
  if [event_type] == "raw_line" {

    grok {
      match => {
        "message" => [
          "^builder:\s+%{GREEDYDATA:builder}$",
          "^results:\s+%{WORD:result_status}\s+\(%{NUMBER:result_code:int}\)$"
        ]
      }
      tag_on_failure => []
    }

    if [builder] {
      aggregate {
        task_id => "%{[@metadata][file_id]}"
        code => "map['builder'] = event.get('builder')"
      }
      drop {}
    }

    if [result_status] {
      aggregate {
        task_id => "%{[@metadata][file_id]}"
        code => "
          map['result_status'] = event.get('result_status')
          map['result_code'] = event.get('result_code')
        "
      }
      drop {}
    }

    aggregate {
      task_id => "%{[@metadata][file_id]}"
      code => "
        event.set('builder', map['builder'])
        event.set('result_status', map['result_status'])
      "
    }
  }

  # ---------------- FILE END ----------------
  if [event_type] == "file_end" {
    aggregate {
      task_id => "%{[@metadata][file_id]}"
      end_of_task => true
      code => "
        if map && map['builder']
          event.set('record_type', 'job_header')
          event.set('day_folder', map['day_folder'])
          event.set('filename', map['filename'])
          event.set('path', map['path'])
          event.set('builder', map['builder'])
          event.set('result_status', map['result_status'])
        else
          event.cancel
        end
      "
    }
  }

  # ---------------- INDEX DATE ----------------
  if [day_folder] {
    grok {
      match => { "day_folder" => "^log-%{YEAR:yyyy}-%{MONTHNUM:mm}-%{MONTHDAY:dd}$" }
    }
    mutate {
      add_field => { "[@metadata][index_date]" => "%{yyyy}.%{mm}.%{dd}" }
      remove_field => ["yyyy","mm","dd"]
    }
  }
}

output {
  if [record_type] == "job_header" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "ci-jobs-%{[@metadata][index_date]}"
    }
  } else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "ci-events-%{[@metadata][index_date]}"
    }
  }
}
